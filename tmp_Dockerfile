FROM node:22

# Environment variables
ENV NODE_ENV=production \
	POPULATE_DB=true \
	DB_URI="_DBURI_" \
	BASIC_AUTH_USERNAME="_BASICAUTHUSERNAME_" \
	BASIC_AUTH_PASSWORD="_BASICAUTHPASSWORD_" \
	WAIT_HOSTS="_WAITHOSTS_"

# Install system dependencies and clean up
RUN apt-get update && apt-get install -y \
	dos2unix \
	netcat-openbsd \
	openssh-server \
	vim \
	&& rm -rf /var/lib/apt/lists/*

# Set up app directory
RUN mkdir -p /home/app /run/sshd
WORKDIR /home/app
SHELL ["/bin/bash", "-c"]

# Copy SSH config
COPY sshd_config /etc/ssh/

# Copy app source
COPY . .

# Convert scripts and make them executable
RUN dos2unix ./scripts/start.sh && \
	chmod +x ./scripts/start.sh

# Debugging: show copied files
RUN echo "Contents of /home/app:" && \
	ls -al /home/app && \
	find /home/app -type f

# Install Node.js dependencies
RUN npm install

# Set root password for SSH
RUN echo "root:Docker!" | chpasswd

# Expose port
EXPOSE 3000

# Start the app
ENTRYPOINT ["/bin/bash", "scripts/start.sh"]
